# Nginx config for EWERS app - copy to /etc/nginx/sites-available/ewers
# Includes HTTPS, WebSocket support for Socket.io, and HTTP->HTTPS redirect
#
# SETUP INSTRUCTIONS:
# -------------------
# Option A — Let's Encrypt (requires a domain name, e.g. ewers.example.com):
#   1. sudo apt install certbot python3-certbot-nginx
#   2. Replace YOUR_DOMAIN below with your actual domain
#   3. sudo certbot --nginx -d YOUR_DOMAIN
#   4. Certbot auto-edits this file and handles renewal
#
# Option B — Self-signed certificate (works with IP address, browser will warn):
#   1. sudo mkdir -p /etc/nginx/ssl
#   2. sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#        -keyout /etc/nginx/ssl/ewers.key -out /etc/nginx/ssl/ewers.crt \
#        -subj "/C=NG/ST=FCT/L=Abuja/O=IPCR/CN=134.209.178.224"
#   3. Uncomment the HTTPS server block below and reload nginx
#
# After setup: sudo nginx -t && sudo systemctl reload nginx

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# --- HTTP server: redirect to HTTPS when SSL is active ---
server {
    listen 80;
    server_name _;

    # Uncomment the next line once SSL is configured to force HTTPS:
    # return 301 https://$host$request_uri;

    # --- Remove everything below this line once HTTPS redirect is active ---
    client_max_body_size 50M;

    # Increase buffer sizes for WebSocket
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
    proxy_temp_file_write_size 256k;

    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    location / {
        proxy_pass http://127.0.0.1:4342;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Socket.io — WebSocket and long-polling
    location /socket.io/ {
        proxy_pass http://127.0.0.1:4342;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }
}

# --- HTTPS server: uncomment this block after generating SSL certificates ---
# server {
#     listen 443 ssl http2;
#     server_name _;
#
#     # SSL certificates — update paths for Let's Encrypt or self-signed
#     ssl_certificate     /etc/nginx/ssl/ewers.crt;
#     ssl_certificate_key /etc/nginx/ssl/ewers.key;
#
#     # Modern SSL settings
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
#     ssl_prefer_server_ciphers off;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 1d;
#
#     client_max_body_size 50M;
#
#     # Increase buffer sizes for WebSocket
#     proxy_buffer_size 128k;
#     proxy_buffers 4 256k;
#     proxy_busy_buffers_size 256k;
#     proxy_temp_file_write_size 256k;
#
#     # Timeouts
#     proxy_connect_timeout 60s;
#     proxy_send_timeout 60s;
#     proxy_read_timeout 60s;
#
#     location / {
#         proxy_pass http://127.0.0.1:4342;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection $connection_upgrade;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_cache_bypass $http_upgrade;
#     }
#
#     # Socket.io — WebSocket and long-polling
#     location /socket.io/ {
#         proxy_pass http://127.0.0.1:4342;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection $connection_upgrade;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_cache_bypass $http_upgrade;
#         proxy_read_timeout 86400s;
#         proxy_send_timeout 86400s;
#     }
# }
